services:
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    ports:
      - '3000:3000'
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:3000/docs/openapi.json']
      interval: 1s
      timeout: 5s
      retries: 30
      start_period: 5s

  frontend:
    build:
      context: .
      dockerfile: apps/frontend/Dockerfile
    ports:
      - '4173:4173'
    environment:
      - VITE_BACKEND_URL=http://backend:3000
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:4173/']
      interval: 1s
      timeout: 5s
      retries: 30
      start_period: 5s
    depends_on:
      backend:
        condition: service_healthy

  schemathesis:
    image: schemathesis/schemathesis
    command: run http://backend:3000/docs/openapi.json --continue-on-failure --max-examples 100
    volumes:
      - ./schemathesis.toml:/app/schemathesis.toml:z
    depends_on:
      backend:
        condition: service_healthy

  e2e:
    build:
      context: .
      dockerfile: apps/e2e/Dockerfile
    command: pnpm -F e2e test:e2e
    environment:
      - CI=true
      - PLAYWRIGHT_BASE_URL=http://frontend:4173
    volumes:
      - ./apps/e2e/test-results:/app/apps/e2e/test-results:z
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
